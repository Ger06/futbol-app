name: Add Magic TV Channel

on:
  workflow_dispatch:
    inputs:
      home_team:
        description: 'Equipo local (ej: Barcelona, River, Boca)'
        required: true
        type: string
      away_team:
        description: 'Equipo visitante (ej: Real Madrid, Racing)'
        required: true
        type: string
      channel:
        description: 'Canal Magic TV (ej: 336, ESPN)'
        required: true
        type: string

jobs:
  add-channel:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Add Magic TV channel to match
        run: |
          echo "Agregando Magic TV ${{ github.event.inputs.channel }} a:"
          echo "  ${{ github.event.inputs.home_team }} vs ${{ github.event.inputs.away_team }}"
          echo ""

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.SITE_URL }}/api/admin/add-magic-tv" \
            -H "Authorization: Bearer ${{ secrets.ADMIN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "homeTeam": "${{ github.event.inputs.home_team }}",
              "awayTeam": "${{ github.event.inputs.away_team }}",
              "channel": "${{ github.event.inputs.channel }}"
            }')

          # Separar body y status code
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"

          # Verificar respuesta exitosa
          if [ "$HTTP_CODE" == "200" ]; then
            echo ""
            echo "=== Agregado exitosamente ==="
            echo "$BODY" | jq -r '.message // "Canal agregado"'
          elif [ "$HTTP_CODE" == "404" ]; then
            echo ""
            echo "=== Partido no encontrado ==="
            echo "Verifica que los nombres de equipos sean correctos"
            echo "$BODY" | jq -r '.error // "No encontrado"'
            exit 1
          else
            echo ""
            echo "=== Error ==="
            echo "$BODY" | jq -r '.error // "Error desconocido"'
            exit 1
          fi

      - name: Summary
        if: success()
        run: |
          echo "Magic TV ${{ github.event.inputs.channel }} agregado a ${{ github.event.inputs.home_team }} vs ${{ github.event.inputs.away_team }}"
