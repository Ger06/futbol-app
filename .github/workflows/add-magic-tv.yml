name: Add Broadcasters (TV Channels)

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Modo: single (un partido) o bulk (varios)'
        required: true
        default: 'bulk'
        type: choice
        options:
          - bulk
          - single
      input:
        description: 'BULK: "River vs Boca: ESPN, Magic 503 | Racing vs Indep: Fox"'
        required: false
        type: string
      home_team:
        description: 'SINGLE: Equipo local (ej: River)'
        required: false
        type: string
      away_team:
        description: 'SINGLE: Equipo visitante (ej: Boca)'
        required: false
        type: string
      channel:
        description: 'SINGLE: Canal (ej: ESPN o Magic 503)'
        required: false
        type: string

jobs:
  add-broadcasters:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Add broadcasters to matches
        run: |
          echo "Modo: ${{ github.event.inputs.mode }}"
          echo ""

          if [ "${{ github.event.inputs.mode }}" == "bulk" ]; then
            echo "Procesando m√∫ltiples partidos..."
            echo "Input: ${{ github.event.inputs.input }}"

            PAYLOAD=$(jq -n --arg input "${{ github.event.inputs.input }}" '{input: $input}')
          else
            echo "Procesando partido individual..."
            echo "${{ github.event.inputs.home_team }} vs ${{ github.event.inputs.away_team }}: ${{ github.event.inputs.channel }}"

            PAYLOAD=$(jq -n \
              --arg home "${{ github.event.inputs.home_team }}" \
              --arg away "${{ github.event.inputs.away_team }}" \
              --arg channel "${{ github.event.inputs.channel }}" \
              '{homeTeam: $home, awayTeam: $away, channel: $channel}')
          fi

          echo ""
          echo "Payload: $PAYLOAD"
          echo ""

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.SITE_URL }}/api/admin/add-magic-tv" \
            -H "Authorization: Bearer ${{ secrets.ADMIN_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"

          if [ "$HTTP_CODE" == "200" ]; then
            echo ""
            echo "=== Resultado ==="
            echo "$BODY" | jq -r '.message // "OK"'
            echo ""
            echo "Partidos actualizados:"
            echo "$BODY" | jq -r '.results[]?.match // empty'

            if [ "$(echo "$BODY" | jq -r '.errors | length')" != "0" ]; then
              echo ""
              echo "Errores:"
              echo "$BODY" | jq -r '.errors[]? | "\(.match): \(.error)"'
            fi
          else
            echo ""
            echo "=== Error ==="
            echo "$BODY" | jq -r '.error // "Error desconocido"'
            exit 1
          fi
